---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=6, fig.asp = 0.618, collapse=TRUE) 
```

### In-class exercises
### Unit 3: Penguins

```{r}
library(tidyverse)
library(palmerpenguins)
```

***

### Exercise 1.1

Build a data set that contains only Chinstrap penguins with a flipper length > 200 mm. What is the percentage of females in that subset of data? How does that compare to the percentage of all female Chinstrap penguins included in the original data set? Use the `summary()` function to compare the sex ratio of the full Chinstrap dataset vs. the subset of Chinstrap penguins with a flipper length > 200 mm. Or you can use again subset the data by sex and use the `dim()` function to count the number of rows in the subsetted data. Given this analysis, what do you think the relationship is between sex and flipper length?

```{r}
# Sex ratio of all Chinstrap observations
summary(penguins %>% filter(species=="Chinstrap"))
sex_ratio_all = 34/68
dim(penguins %>% filter(species=="Chinstrap") %>% filter(sex=="female"))[1]/dim(penguins %>% filter(species=="Chinstrap"))[1]

# Sex ratio of Chinstrap penguins with flipper length > 200 mm
dat_exer_1 = penguins %>%
  filter(species == "Chinstrap",
         flipper_length_mm > 200)
summary(dat_exer_1)
sex_ratio_subset = 1/18
dim(dat_exer_1 %>% filter(sex=="female"))[1]/dim(dat_exer_1)[1]
```

***

### Exercise 1.2

Repeat Exercise 1.1, but this time use `group_by()` along with the `n()` function inside `summarize()` to count the number of Chinstrap penguins of each sex. Again compare the sex ratio of all Chinstrap observations vs. the sex ratio of Chinstrap penguins with a flipper length > 200 mm.

```{r}
penguins %>%
  filter(species == "Chinstrap") %>%
  group_by(sex) %>%
  summarize(n=n())


penguins %>%
  filter(species == "Chinstrap",
         flipper_length_mm > 200) %>%
  group_by(sex) %>%
  summarize(n=n())
```

***

### Exercise 1.3

What is the mean bill length (in inches) of Adelie penguins found on either Dream island or Biscoe island? What is the standard deviation? Is the mean larger or smaller than the mean bill length of Adelie penguins found on Torgersen island?

```{r}
penguins %>% 
  filter(species=="Adelie",
         island %in% c("Biscoe","Dream")) %>%
  mutate(bill_length_in = bill_length_mm * 0.039) %>% # Conversion: 0.0393701 inches / mm
  summarize(mean_bill_length_in = mean(bill_length_in), sd_bill_length_in = sd(bill_length_in))

penguins %>% 
  filter(species=="Adelie",
         island =="Torgersen",
         !is.na(bill_length_mm)) %>%
  mutate(bill_length_in = bill_length_mm * 0.039) %>% # Conversion: 0.0393701 inches / mm
  summarize(mean_bill_length_in = mean(bill_length_in), sd_bill_length_in = sd(bill_length_in))
```

***

### Exercise 2.1

Build a scatter plot of bill depth vs. bill length for Adelie penguins. Map the point colors to the island that the Adelie penguin was observed on. Add axes labels and a main title. 

```{r}
adelie = penguins %>%
  filter(species=="Adelie")
ggplot(data = adelie) + 
  geom_point(aes(y=bill_depth_mm, x=bill_length_mm, color=island)) + 
  xlab("Bill length (mm)") +
  ylab("Bill Depth (mm)") +
  ggtitle("Adelie bills")
```

***

### Exercise 2.2

Build another scatter plot of bill depth vs. bill length for all three penguin species. Map the point colors to the penguin's sex. Use `facet_wrap()` to plot each species in a separate panel. Look at the documentation for `facet_wrap()` and play around with the `scales` parameter. What is the default value? Try plotting with the parameter `scales="free"`. Instead of using the default theme, choose a different pre-packaged theme (I like `theme_bw()` and `theme_classic()`). Save the plot.

```{r}
ggplot(data = penguins) + 
  geom_point(aes(y=bill_depth_mm, x=bill_length_mm, color=sex)) + 
  facet_wrap(~species, scales="free") + 
  theme_classic() +
  ggsave(filename = "figures/bill_depth_v_length.png", device = "png", width = 6, height = 3.5, units = "in", dpi = 300)
```

***

### Exercise 3.1

Are Adelie penguin flipper lengths significantly different between males and females? Do some exploratory data analysis. Compute summary statistics and plot histograms. Then conduct an independent sample t-test. What do your results show?

```{r}
library(rstatix) # t_test()

# Simplify the dataset to what we need
ex_1_data = penguins %>%
  filter(species =="Adelie",
         !is.na(flipper_length_mm),
         !is.na(sex)) %>%   # students may forget to do this
  dplyr::select(sex, flipper_length_mm) %>%
  droplevels() # This removes the "Chinstrap" level from the species factor

# Calculate summary stats
ex_1_data %>%
  group_by(sex) %>%
  summarize(mean=mean(flipper_length_mm), sd=sd(flipper_length_mm))

# Plot a quick histogram:
ggplot() +
  geom_histogram(aes(x=flipper_length_mm), data=ex_1_data) +
  facet_wrap(~sex)

# Base R:
t.test(ex_1_data$flipper_length_mm ~ ex_1_data$sex)
# rstatix:
ex_1_data %>% 
  t_test(flipper_length_mm ~ sex)
# Flipper length is significantly different between the 2 sexes
```

***

### Exercise 4.1

Calculate the correlation between bill length and bill depth with all 3 penguin species combined into a single data set. Is the correlation stronger or weaker compared to the correlation between bill length and bill depth for Gentoo penguins alone? Do you notice anything unexpected about this correlation?

```{r}
# Check normality assumption with a qqplot:
ggplot(penguins) +
  stat_qq(aes(sample=bill_length_mm))
ggplot(penguins) +
  stat_qq(aes(sample=bill_depth_mm))

cor.test(x=penguins$bill_length_mm, y=penguins$bill_depth_mm, use="complete.obs")
# Correlation is much weaker with all penguins combined than with Gentoo alone
# Correlation with all penguins combined is NEGATIVE - why would bill length get bigger as bill depth gets smaller?
```

***

### Exercise 5.1

Build a model predicting Gentoo bill length as a function of flipper length. Plot the predictions. Which explanatory variable (bill length vs. flipper length) does a better job of predicting bill depth? What is your evidence?

```{r}
gentoo = penguins %>% filter(species=="Gentoo")

lm_bill_length = lm(bill_depth_mm ~ bill_length_mm, data=gentoo)
summary(lm_bill_length)

lm_flip = lm(bill_depth_mm ~ flipper_length_mm, data=gentoo)
summary(lm_flip)

ggplot(data=gentoo, aes(x = flipper_length_mm, y = bill_depth_mm)) +
     geom_point() +
     geom_smooth(method = "lm")
```

The Adjusted $R^2$ is higher in the flipper model than in the bill length model, so flipper length does a better job of predicting bill depth for Gentoo penguins.

***

### Exercise 5.2

Build a linear regression to predict the bill depth of Gentoo penguins as a function of 2 explanatory continuous variables: bill length and flipper length. Do some exploratory data analysis and check model diagnostics. Use the function `vif()` to make sure that you don't have a problem with multicollinearity. Then use the function `AIC()` to compare the Akaike Information Criterion between this model and a simple linear regression we built before with bill depth as a function of just bill length. Use the help pages or the tutorial on regression diagnostics in this unit to make sure you are using `vif()` and `AIC()` correctly. What are your findings? Plot the data, the model predictions and the 95% confidence intervals or the standard errors.

####3!!!!!!!!!!!1######### Work on how we'll plot the predictions for 2 continuous variables

```{r}
library(gvlma) # gvlma()
library(car)  # vif()
library(ggiraph)
library(ggiraphExtra) # ggPredict()

# Drop NA data before fitting model. This helps me avoid problems down the line with predict()
gentoo = penguins %>%
  filter(!is.na(bill_depth_mm),
         !is.na(bill_length_mm),
         !is.na(species),
         species=="Gentoo")

# Build simple linear regression
lm_gentoo_1 = lm(bill_depth_mm ~ bill_length_mm, data=gentoo)
summary(lm_gentoo_1)

# Build multiregression
lm_gentoo_3x = lm(bill_depth_mm ~ bill_length_mm + flipper_length_mm, data=gentoo)
summary(lm_gentoo_3x) # bill length no longer significant

vif(lm_gentoo_3x) # vif values < 2, no multicollinearity
AIC(lm_gentoo_1, lm_gentoo_3x) # lm_gentoo_male_3x performs significantly better

ggPredict(lm_gentoo_3x, se=TRUE, interactive=TRUE)
```









